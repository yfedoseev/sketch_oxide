name: Publish Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true

jobs:
  # Publish to crates.io (Rust)
  publish-rust:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        working-directory: ./sketch_oxide
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_TOKEN }}

  # Publish to PyPI (Python) - Multi-platform wheels
  build-python-wheels:
    name: Build Python wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux wheels
          - os: ubuntu-latest
            python-version: "3.11"
            target: x86_64-unknown-linux-gnu
          # macOS Intel
          - os: macos-latest
            python-version: "3.11"
            target: x86_64-apple-darwin
          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            python-version: "3.11"
            target: aarch64-apple-darwin
          # Windows x86_64
          - os: windows-latest
            python-version: "3.11"
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Rust toolchain for macOS ARM64
        if: matrix.target == 'aarch64-apple-darwin'
        run: rustup target add aarch64-apple-darwin

      - name: Install maturin
        run: pip install maturin

      - name: Build wheels
        working-directory: ./python
        run: maturin build --release --target ${{ matrix.target }}

      - name: Upload wheels as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-wheels
          path: python/target/wheels/
          retention-days: 1
          if-no-files-found: warn

  # Publish all Python wheels to PyPI
  publish-python:
    name: Publish Python to PyPI
    runs-on: ubuntu-latest
    needs: build-python-wheels
    steps:
      - uses: actions/checkout@v4

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-wheels
          path: wheels

      - name: Verify wheels
        run: |
          echo "=== Downloaded wheels ==="
          ls -la wheels/
          wheel_count=$(find wheels -name "*.whl" | wc -l)
          echo "Total wheels: $wheel_count"
          if [ "$wheel_count" -lt 4 ]; then
            echo "Warning: Expected at least 4 wheels, found $wheel_count"
          fi

      - name: Install build dependencies
        run: pip install maturin twine

      - name: Publish to PyPI
        run: |
          twine upload wheels/* \
            -u __token__ \
            -p ${{ secrets.PYPI_TOKEN }} \
            --skip-existing \
            --non-interactive
        env:
          TWINE_REPOSITORY_URL: https://upload.pypi.org/legacy/

  # Publish to npm (Node.js)
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          registry-url: 'https://registry.npmjs.org'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        working-directory: ./nodejs
        run: npm ci

      - name: Build and publish
        working-directory: ./nodejs
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Publish to Maven Central (Java)
  publish-maven:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin
          cache: maven

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Import GPG key
        run: |
          mkdir -p ~/.gnupg
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | base64 -d > ~/.gnupg/private.key
          gpg --import ~/.gnupg/private.key

      - name: Deploy to Maven Central
        working-directory: ./java
        run: |
          mvn clean deploy -Pmaven-central \
            -DskipTests \
            -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }}
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

  # Publish to NuGet (C#)
  publish-nuget:
    name: Publish to NuGet
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build package
        working-directory: ./dotnet
        run: dotnet pack -c Release

      - name: Publish to NuGet
        working-directory: ./dotnet
        run: dotnet nuget push "SketchOxide/bin/Release/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

  # Create release summary
  release-summary:
    name: Create Release Summary
    runs-on: ubuntu-latest
    needs: [publish-rust, publish-python, publish-npm, publish-maven, publish-nuget]
    if: always() && !failure()
    steps:
      - uses: actions/checkout@v4

      - name: Create release comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
            const versionMatch = changelog.match(/## \[([\d.]+)\]/);
            const version = versionMatch ? versionMatch[1] : 'v0.1.0';
            const comment = '## Release ' + version + ' Published\n\n' +
              '### Package Availability:\n' +
              '- Rust (crates.io): cargo add sketch_oxide\n' +
              '- Python (PyPI): pip install sketch-oxide (Linux, macOS Intel/ARM64, Windows)\n' +
              '- Node.js (npm): npm install sketch-oxide-node\n' +
              '- Java (Maven Central): See pom.xml configuration\n' +
              '- C# (NuGet): dotnet add package SketchOxide\n\n' +
              'All binaries are built and published to their respective registries across all major platforms.';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Build and test on publish
  verify:
    name: Verify Published Packages
    runs-on: ubuntu-latest
    needs: [publish-rust, publish-python, publish-npm, publish-maven, publish-nuget]
    if: always() && !failure()
    steps:
      - name: Verify crates.io
        run: |
          cargo search sketch_oxide --limit 1

      - name: Verify PyPI
        run: |
          pip index versions sketch-oxide 2>/dev/null || echo "Package may take time to appear on PyPI"

      - name: Verify npm
        run: |
          npm view sketch-oxide-node 2>/dev/null || echo "Package may take time to appear on npm"
