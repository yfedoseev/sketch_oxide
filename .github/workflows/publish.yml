name: Publish Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true

jobs:
  # Publish to crates.io (Rust)
  publish-rust:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        working-directory: ./sketch_oxide
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_TOKEN }}

  # Publish to PyPI (Python)
  publish-python:
    name: Publish to PyPI
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            python-version: "3.11"
          - os: macos-latest
            python-version: "3.11"
          - os: windows-latest
            python-version: "3.11"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build dependencies
        run: pip install maturin twine

      - name: Build wheels
        working-directory: ./python
        run: maturin build --release

      - name: Upload to PyPI (Linux/Mac/Windows)
        if: matrix.os == 'ubuntu-latest'
        run: twine upload python/target/wheels/* -u __token__ -p ${{ secrets.PYPI_TOKEN }} --skip-existing

  # Publish to npm (Node.js)
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          registry-url: 'https://registry.npmjs.org'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        working-directory: ./nodejs
        run: npm ci

      - name: Build and publish
        working-directory: ./nodejs
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Publish to Maven Central (Java)
  publish-maven:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin
          cache: maven

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Import GPG key
        run: |
          mkdir -p ~/.gnupg
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | base64 -d > ~/.gnupg/private.key
          gpg --import ~/.gnupg/private.key

      - name: Deploy to Maven Central
        working-directory: ./java
        run: |
          mvn clean deploy -Pmaven-central \
            -DskipTests \
            -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }}
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

  # Publish to NuGet (C#)
  publish-nuget:
    name: Publish to NuGet
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build package
        working-directory: ./dotnet
        run: dotnet pack -c Release

      - name: Publish to NuGet
        working-directory: ./dotnet
        run: dotnet nuget push "SketchOxide/bin/Release/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

  # Create release summary
  release-summary:
    name: Create Release Summary
    runs-on: ubuntu-latest
    needs: [publish-rust, publish-python, publish-npm, publish-maven, publish-nuget]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Create release comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
            const versionMatch = changelog.match(/## \[([\d.]+)\]/);
            const version = versionMatch ? versionMatch[1] : 'v0.1.0';
            const comment = '## Release ' + version + ' Published\n\n' +
              '### Package Availability:\n' +
              '- Rust (crates.io): cargo add sketch_oxide\n' +
              '- Python (PyPI): pip install sketch-oxide\n' +
              '- Node.js (npm): npm install @sketch-oxide/node\n' +
              '- Java (Maven Central): See pom.xml configuration\n' +
              '- C# (NuGet): dotnet add package SketchOxide\n\n' +
              'All binaries are built and published to their respective registries.';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Build and test on publish
  verify:
    name: Verify Published Packages
    runs-on: ubuntu-latest
    needs: [publish-rust, publish-python, publish-npm, publish-maven, publish-nuget]
    if: always()
    steps:
      - name: Verify crates.io
        run: |
          cargo search sketch_oxide --limit 1

      - name: Verify PyPI
        run: |
          pip index versions sketch-oxide 2>/dev/null || echo "Package may take time to appear on PyPI"

      - name: Verify npm
        run: |
          npm view @sketch-oxide/node 2>/dev/null || echo "Package may take time to appear on npm"
